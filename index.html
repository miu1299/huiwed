<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Quáº£n LÃ½ Há»¥i</title>

<!-- ===== ThÃªm cho iOS: logo khi thÃªm vÃ o mÃ n hÃ¬nh chÃ­nh ===== -->
<link rel="apple-touch-icon" href="logo.png"> <!-- Ä‘Æ°á»ng dáº«n tá»›i logo cá»§a báº¡n -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Quáº£n LÃ½ Há»¥i">

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
h2{color:#2c3e50;margin-bottom:3px}
.sub{color:#555;margin-bottom:8px;font-style:italic}
.chuHui{color:#c0392b;font-weight:bold;margin-bottom:10px}
.info{background:#fff;padding:10px;border-radius:6px;margin-bottom:10px}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#3498db;color:#fff}
button{padding:6px 10px;border:none;border-radius:4px;cursor:pointer}
.them{background:#27ae60;color:#fff}
.hot{background:#f39c12;color:#fff}
.xoa{background:#c0392b;color:#fff}
.ky{background:#8e44ad;color:#fff}
.song{color:#27ae60;font-weight:bold}
.chet{color:#7f8c8d;font-weight:bold}
.hotNguoi{color:#e74c3c;font-weight:bold}
.tongHot{margin-top:10px;font-size:16px;font-weight:bold}
</style>

</head>

<body>

<h2>ğŸ“‹ QUáº¢N LÃ Há»¤I</h2>
<div class="sub">Há»¥i 20.000.000 Ä‘ / 1 thÃ¡ng</div>
<div class="chuHui">Chá»§ há»¥i: Nguyá»…n Háº±ng Ni</div>

<div class="info">
<b>Ká»³:</b>
<button class="ky" onclick="doiKy(-1)">â¬…</button>
<input type="number" id="ky" value="1" onchange="capNhatKy()">
<button class="ky" onclick="doiKy(1)">â¡</button>
&nbsp;&nbsp;
<b>NgÃ y khui:</b>
<input type="date" id="ngayKhui" onchange="capNhatNgay()">
</div>

<button class="them" onclick="themNguoi()" id="btnThem">â• ThÃªm ngÆ°á»i</button>
<button class="ky" onclick="xuatPDF()">ğŸ“¤ Xuáº¥t PDF gá»­i Zalo</button>
<button class="xoa" onclick="resetHui()" id="btnReset">â™» Reset dÃ¢y há»¥i</button>

<table>
<thead>
<tr>
<th>TÃªn</th>
<th>ÄÃ£ Ä‘Ã³ng</th>
<th>Tiá»n Ä‘Ã³ng</th>
<th>Bá» thÄƒm</th>
<th>Há»‘t</th>
<th>XoÃ¡</th>
</tr>
</thead>
<tbody id="bang"></tbody>
</table>

<div class="tongHot" id="tongHot"></div>

<script>
const TIEN_HUI = 20000000;

let data = {
  ky:1,
  ngay:{},
  tongHot:{},
  danhSach:[]
};

function luuDuLieu(){
  localStorage.setItem("huiData",JSON.stringify(data));
}
function taiDuLieu(){
  let d=localStorage.getItem("huiData");
  if(d) data=JSON.parse(d);
}

function capNhatKy(){
  data.ky=parseInt(ky.value)||1;
  luuDuLieu(); veBang();
}
function doiKy(s){
  data.ky+=s; if(data.ky<1) data.ky=1;
  ky.value=data.ky; luuDuLieu(); veBang();
}
function capNhatNgay(){
  data.ngay[data.ky]=ngayKhui.value; luuDuLieu();
}

function themNguoi(){
  data.danhSach.push({ten:"NgÆ°á»i "+(data.danhSach.length+1),lichSu:{}});
  luuDuLieu(); veBang();
}

function daChet(n){
  let kyHienTai = data.ky;
  for(let k in n.lichSu){
    if(Number(k) < kyHienTai && n.lichSu[k].daHot){
      return true;
    }
  }
  return false;
}

function tickDong(i){
  let ls=data.danhSach[i].lichSu[data.ky];
  if(ls){ ls.daDong=!ls.daDong; luuDuLieu(); veBang(); }
}

function hotHui(i){
  let ky=data.ky;
  let bo=parseInt(prompt("Nháº­p tiá»n bá» thÄƒm:"));
  if(isNaN(bo)||bo<0) return;

  data.danhSach.forEach(n=>{
    if(!n.lichSu[ky])
      n.lichSu[ky]={dong:TIEN_HUI,daDong:false,daHot:false,boTham:0};
  });

  data.danhSach[i].lichSu[ky].daHot=true;
  data.danhSach[i].lichSu[ky].dong=0;
  data.danhSach[i].lichSu[ky].boTham=bo;

  let tong=0;
  data.danhSach.forEach((n,idx)=>{
    if(idx!==i){
      if(!daChet(n)) n.lichSu[ky].dong=TIEN_HUI-bo;
      else n.lichSu[ky].dong=TIEN_HUI;
      tong+=n.lichSu[ky].dong;
    }
  });

  data.tongHot[ky]=tong;
  alert("ğŸ’° Há»‘t Ä‘Æ°á»£c "+tong.toLocaleString()+" Ä‘");
  luuDuLieu(); veBang();
}

function veBang(){
  ky.value=data.ky;
  ngayKhui.value=data.ngay[data.ky]||"";
  let html="";
  data.danhSach.forEach((n,i)=>{
    let ls=n.lichSu[data.ky];
    html+=`
<tr>
<td>
 <input value="${n.ten}"
  oninput="data.danhSach[${i}].ten=this.value;luuDuLieu()"
  style="
    width:100%;
    border:none;
    text-align:center;
    background:transparent;
    font-size:20px;
    font-weight:bold;
  ">
</td>
<td onclick="tickDong(${i})" style="cursor:pointer;">
 ${ls?.daDong?"âœ”":""}
</td>
<td>${ls?ls.dong.toLocaleString()+" Ä‘":""}</td>
<td>${ls?.boTham?ls.boTham.toLocaleString()+" Ä‘":""}</td>
<td>
${ls?.daHot?"ğŸ”¥ ÄÃƒ Há»T":daChet(n)?"â˜  CHÆ¯NG CHáº¾T":"âœ” CHÆ¯NG Sá»NG"}
${!ls?.daHot && !daChet(n)?`<br><button class="hot" onclick="hotHui(${i})">Há»‘t</button>`:""}</td>
<td><button class="xoa" onclick="data.danhSach.splice(${i},1);luuDuLieu();veBang()">âŒ</button></td>
</tr>`; 
  });
  bang.innerHTML=html;
  let tenNguoiHot = "";
  data.danhSach.forEach(n => {
    let ls = n.lichSu[data.ky];
    if (ls?.daHot) tenNguoiHot = n.ten;
  });
  tongHot.innerHTML = data.tongHot[data.ky] ?
    "ğŸ’° <b>" + tenNguoiHot + "</b> há»‘t: <b>" +
    data.tongHot[data.ky].toLocaleString() + " Ä‘</b>" : "";
}

/* ===== DIá»„N GIáº¢I PDF CHá»ˆ CHá»ˆNH MÃ€U ===== */
function taoDienGiaiPDF(){
  let ky = data.ky;
  let tienDauThao = 10000000;
  let tenNguoiHot = data.danhSach.find(n=>n.lichSu[ky]?.daHot)?.ten || "ChÆ°a há»‘t";

  let bangNguoi = `
<table style="width:100%;border-collapse:collapse;">
<thead>
<tr style="background:#3498db;color:#fff">
<th>TÃªn</th>
<th>ÄÃ£ Ä‘Ã³ng</th>
<th>Tiá»n Ä‘Ã³ng</th>
<th>Bá» thÄƒm</th>
<th>Tráº¡ng thÃ¡i</th>
</tr>
</thead>
<tbody>
${data.danhSach.map(n=>{
  let ls = n.lichSu[ky];
  let trangThai = ls?.daHot ? "ğŸ”¥ Há»T Ká»² NÃ€Y" : daChet(n) ? "â˜  CHÆ¯NG CHáº¾T" : "âœ” CHÆ¯NG Sá»NG";
  let mau = ls?.daHot ? "#d4edda"
             : daChet(n) ? "#f8d7da"
             : "#ffffff";
  return `<tr style="background:${mau};color:#000">
    <td>${n.ten}</td>
    <td>${ls?.daDong?"âœ”":""}</td>
    <td>${ls?ls.dong.toLocaleString()+" Ä‘":""}</td>
    <td>${ls?.boTham?ls.boTham.toLocaleString()+" Ä‘":""}</td>
    <td>${trangThai}</td>
  </tr>`;
}).join("")}
</tbody>
</table>`;

  let tongTienTruocDauThao = data.danhSach.reduce((acc,n)=>{
    let ls = n.lichSu[ky];
    if(ls){
      if(ls.daHot) return acc;
      return acc + ls.dong;
    }
    return acc;
  },0);

  let thucNhan = tongTienTruocDauThao - tienDauThao;

  return `
<div style="margin-top:20px;padding:15px;border:2px dashed #444;font-size:18px;line-height:1.6">
<b>ğŸ“Œ THÃ”NG TIN Há»T Há»¤I â€“ Ká»² ${ky}</b><br><br>
${bangNguoi}
<div style="margin-top:10px;font-weight:bold;color:#000">
NgÆ°á»i há»‘t: ${tenNguoiHot}<br>
Tá»•ng tiá»n há»¥i: ${tongTienTruocDauThao.toLocaleString()} Ä‘<br>
Trá»« Ä‘áº§u tháº£o: ${tienDauThao.toLocaleString()} Ä‘<br>
<b>ğŸ‘‰ Thá»±c nháº­n: ${thucNhan.toLocaleString()} Ä‘</b>
</div>
</div>`;
}

/* ===== THÃ”NG TIN CHá»¦ Há»¤I + QR THANH TOÃN ===== */
function thongTinChuHuiQR(){
  let bankId = "MB";
  let accountNo = "99999250509";
  let accountName = "NGUYEN+HANG+NI";

  let qrUrl = `https://img.vietqr.io/image/${bankId}-${accountNo}-compact2.png?accountName=${accountName}`;

  return `
  <div style="
    margin-top:30px;
    padding:15px;
    border-top:2px solid #000;
    display:flex;
    gap:20px;
    align-items:center;
    font-size:18px;
    line-height:1.7
  ">
    <img src="${qrUrl}" width="180">
    <div>
      <b>ğŸ‘¤ CHá»¦ Há»¤I</b><br>
      TÃªn: <b>Nguyá»…n Háº±ng Ni</b><br>
      ğŸ“ SÄT: <b>0947 197 319</b><br>
      ğŸ¦ NgÃ¢n hÃ ng: <b>MB Bank</b><br>
      ğŸ’³ STK: <b>99999250509</b><br>
    </div>
  </div>`;
}

/* ===== XUáº¤T PDF ===== */
function xuatPDF(){
  let w = window.open("", "_blank");
  w.document.write(`
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Phiáº¿u há»¥i</title>
<style>
body{font-family:Arial;font-size:18px}
button,input{display:none}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #000;padding:8px;text-align:center}
th{background:#3498db;color:#fff}

/* ===== THÃŠM CHá»® QUAY Láº I (KHÃ”NG IN) ===== */
.quayLai{
  margin-top:30px;
  padding:15px;
  border:2px dashed #333;
  text-align:center;
}
.quayLai button{
  display:inline-block;
  margin-top:10px;
  padding:8px 14px;
  background:#27ae60;
  color:#fff;
  border:none;
  border-radius:5px;
  cursor:pointer;
}
@media print{
  .quayLai{display:none}
}
</style>
</head>
<body>

${taoDienGiaiPDF()}
${thongTinChuHuiQR()}

<!-- ===== THÃŠM KHá»I QUAY Láº I ===== -->
<div class="quayLai">
  ğŸ‘‰ Quay láº¡i Ä‘á»ƒ tiáº¿p tá»¥c dÃ¢y há»¥i / khui ká»³ má»›i<br>
  <button onclick="window.close()">â¬… Quay láº¡i Quáº£n LÃ½ Há»¥i</button>
</div>

<script>
  window.onload = function(){
    setTimeout(()=>{ window.print(); }, 500);
  }
<\/script>

</body>
</html>
  `);
  w.document.close();
}


function resetHui(){
  if(!confirm("Reset toÃ n bá»™ dÃ¢y há»¥i?")) return;
  data={ky:1,ngay:{},tongHot:{},danhSach:[]};
  localStorage.removeItem("huiData");
  veBang();
}

taiDuLieu();
veBang();
</script>

</body>
</html>



